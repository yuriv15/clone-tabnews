echo "üîç Verificando poss√≠veis secrets nos arquivos staged..."

PATTERNS='(AWS_(ACCESS|SECRET)_KEY(ID)?|SECRET|PASSWORD|API[_-]?KEY|PRIVATE[_-]?KEY|TOKEN)[[:space:]]*=[[:space:]]*.+'

FILES=$(git diff --cached --name-only | grep -vE '^\.husky/' || true)

if [ -z "$FILES" ]; then
  echo "‚ÑπÔ∏è Nenhum arquivo relevante nos staged para verificar. Prosseguindo..."
  exit 0
fi

FOUND_SECRET=0

for FILE in $FILES; do
  echo "üìÑ Checando: $FILE"

  MATCHED_LINES=$(git show ":$FILE" | grep -En "$PATTERNS")

  if [ -n "$MATCHED_LINES" ]; then
    SAFE=$(echo "$MATCHED_LINES" | grep -Ev '=(local_password|dummy|dev_token|123456|test123)$')

    if [ -n "$SAFE" ]; then
      echo "üö® Poss√≠vel secret encontrado no arquivo: $FILE"
      echo "$SAFE"
      FOUND_SECRET=1
    fi
  fi
done

if [ "$FOUND_SECRET" -eq 1 ]; then
  echo "‚ùå Commit cancelado: um ou mais arquivos cont√©m poss√≠veis secrets."
  exit 1
fi

echo "‚úÖ Nenhum secret sens√≠vel encontrado. Prosseguindo com o commit."
exit 0
